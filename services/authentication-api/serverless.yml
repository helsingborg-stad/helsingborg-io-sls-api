service: helsingborg-io-sls-authentication-api

plugins:
  - serverless-bundle
  - serverless-offline

custom: ${file(../../serverless.common.yml):custom}

package:
  individually: true

provider:
  name: aws
  runtime: nodejs12.x
  stage: dev
  region: eu-north-1
  tracing:
    apiGateway: true
    lambda: true

  environment:
    stage: ${self:custom.stage}
    resourcesStage: ${self:custom.resourcesStage}
    bankIdApiUrl: https://appapi2.test.bankid.com/rp/v5,
    bankIdPassphrase: qwerty123,
    bankIdPfxBase64: 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,
    bankIdCaString: -----BEGIN CERTIFICATE-----MIIF0DCCA7igAwIBAgIIIhYaxu4khgAwDQYJKoZIhvcNAQENBQAwbDEkMCIGA1UECgwbRmluYW5zaWVsbCBJRC1UZWtuaWsgQklEIEFCMRowGAYDVQQLDBFJbmZyYXN0cnVjdHVyZSBDQTEoMCYGA1UEAwwfVGVzdCBCYW5rSUQgU1NMIFJvb3QgQ0EgdjEgVGVzdDAeFw0xNDExMjExMjM5MzFaFw0zNDEyMzExMjM5MzFaMGwxJDAiBgNVBAoMG0ZpbmFuc2llbGwgSUQtVGVrbmlrIEJJRCBBQjEaMBgGA1UECwwRSW5mcmFzdHJ1Y3R1cmUgQ0ExKDAmBgNVBAMMH1Rlc3QgQmFua0lEIFNTTCBSb290IENBIHYxIFRlc3QwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQCAKWsJc/kV/0434d+Sqn19mIr85RZ/PgRFaUplSrnhuzAmaXihPLCEsd3Mh/YErygcxhQ/MAzi5OZ/anfuWSCwceRlQINtvlRPdMoeZtu29FsntK1Z5r2SYNdFwbRFb8WN9FsU0KvC5zVnuDMgs5dUZwTmdzX5ZdLP7pdgB3zhTnra5ORtkiWiUxJVev9keRgAo00ZHIRJ+xTfiSPdJc314maigVRQZdGKSyQcQMTWi1YLwd2zwOacNxleYf8xqKgkZsmkrc4Dp2mR5PkrnnKB6A7sAOSNatua7M86EgcGi9AaEyaRMkYJImbBfzaNlaBPyMSvwmBZzp2xKc9OD3U06ogV6CJjJL7hSuVc5x/2H04d+2I+DKwep6YBoVL9L81gRYRycqg+w+cTZ1TF/s6NC5YRKSeOCrLw3ombhjyyuPl8T/h9cpXt6m3y2xIVLYVzeDhaql3hdi6IpRh6rwkMhJ/XmOpbDinXb1fWdFOyQwqsXQWOEwKBYIkM6cPnuid7qwaxfP22hDgAolGMLY7TPKUPRwV+a5Y3VPl7h0YSK7lDyckTJdtBqI6d4PWQLnHakUgRQy69nZhGRtUtPMSJ7I4Qtt3B6AwDq+SJTggwtJQHeid0jPki6pouenhPQ6dZT532x16XD+WIcD2f//XzzOueS29KB7lt/wH5K6EuxwIDAQABo3YwdDAdBgNVHQ4EFgQUDY6XJ/FIRFX3dB4Wep3RVM84RXowDwYDVR0TAQH/BAUwAwEB/zAfBgNVHSMEGDAWgBQNjpcn8UhEVfd0HhZ6ndFUzzhFejARBgNVHSAECjAIMAYGBCoDBAUwDgYDVR0PAQH/BAQDAgEGMA0GCSqGSIb3DQEBDQUAA4ICAQA5s59/Olio4svHXiKu7sPQRvrf4GfGB7hUjBGkYW2YOHTYnHavSqlBASHc8gGGwuc7v7+H+vmOfSLZfGDqxnBqeJx1H5E0YqEXtNqWG1JusIFa9xWypcONjg9v7IMnxxQzLYws4YwgPychpMzWY6B5hZsjUyKgB+1igxnfuaBueLPw3ZaJhcCL8gz6SdCKmQpX4VaAadS0vdMrBOmd826H+aDGZek1vMjuH11FfJoXY2jyDnlol7Z4BfHc011toWNMxojI7w+U4KKCbSxpWFVYITZ8WlYHcj+b2A1+dFQZFzQN+Y1Wx3VIUqSks6P7F5aF/l4RBngy08zkP7iLA/C7rm61xWxTmpj3p6SGfUBsrsBvBgfJQHD/Mx8U3iQCa0Vj1XPogE/PXQQq2vyWiAP662hD6og1/om3l1PJTBUyYXxqJO75ux8IWblUwAjsmTlF/Pcj8QbcMPXLMTgNQAgarV6guchjivYqb6Zrhq+Nh3JrF0HYQuMgExQ6VX8T56saOEtmlp6LSQi4HvKatCNfWUJGoYeT5SrcJ6snBy7XLMhQUCOXcBwKbNvX6aP79VA3yeJHZO7XParX7V9BB+jtf4tz/usmAT/+qXtHCCv9Xf4lv8jgdOnFfXbXuT8I4gz8uq8ElBlpbJntO6p/NY5a08E6C7FWVR+WJ5vZOP2HsA==-----END CERTIFICATE-----
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:DescribeTable
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      # Restrict our IAM role permissions to the specific table for the stage
      Resource:
        - "Fn::ImportValue": ${self:custom.resourcesStage}-SubmissionsTableArn

functions:
  # Defines an HTTP API endpoint that calls the main function in create.js
  # - path: url path is /forms
  # - method: POST request
  auth:
    handler: auth.main
    events:
      - http:
          path: api/v1/bankid/auth
          method: post
          cors: true
